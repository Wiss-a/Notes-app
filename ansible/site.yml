---
- name: Deploy NotesApp on Kubernetes
  hosts: servers
  become: true
  gather_facts: true

  tasks:

    # ============================================
    # 1. Install basic tools
    # ============================================
    - name: Install required packages
      apt:
        name:
          - curl
          - jq
          - unzip
          - git
          - apt-transport-https
          - ca-certificates
          - software-properties-common
        state: present
        update_cache: yes

    # ============================================
    # 2. Install Docker
    # ============================================
    - name: Install Docker
      apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Ensure Docker is running
      systemd:
        name: docker
        state: started
        enabled: yes

    # ============================================
    # 3. Install kubectl
    # ============================================
    - name: Install kubectl
      shell: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
      args:
        creates: /usr/local/bin/kubectl

    # ============================================
    # 4. Install Minikube
    # ============================================
    - name: Install Minikube
      shell: |
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        install minikube-linux-amd64 /usr/local/bin/minikube
      args:
        creates: /usr/local/bin/minikube

    # ============================================
    # 5. Install Terraform & initialize
    # ============================================
    - name: Install Terraform
      shell: |
        curl -LO https://releases.hashicorp.com/terraform/1.14.0/terraform_1.14.0_linux_amd64.zip
        unzip terraform_1.14.0_linux_amd64.zip -d /usr/local/bin/
      args:
        creates: /usr/local/bin/terraform
    - name: Initialize Terraform
      command: terraform init
      args:
        chdir: /home/wissal/Notes-app/terraform/k8s
      register: tf_init
      ignore_errors: true
    - name: Terraform plan
      command: terraform plan -out=tfplan
      args:
        chdir: /home/wissal/Notes-app/terraform/k8s
      register: tf_plan
      ignore_errors: true

    - name: Show Terraform plan result
      debug:
        msg: "{{ tf_plan.stdout_lines }}"


    - name: Apply Terraform
      command: terraform apply tfplan
      args:
        chdir: /home/wissal/Notes-app/terraform/k8s
      register: tf_apply

    - name: Show Terraform apply result
      debug:
        msg: "{{ tf_apply.stdout_lines }}"

    # ============================================
    # 6. Start Minikube cluster
    # ============================================
    # - name: Delete any existing Minikube cluster
    #   command: minikube delete
    #   ignore_errors: true

    # - name: Start Minikube (driver=docker)
    #   command: minikube start --driver=docker --force
    #   environment:
    #     MINIKUBE_HOME: /root
    #   async: 600
    #   poll: 0
    #   register: minikube_start_job

    # - name: Wait for Minikube start
    #   async_status:
    #     jid: "{{ minikube_start_job.ansible_job_id }}"
    #   register: job_result
    #   until: job_result.finished
    #   retries: 60
    #   delay: 10

    # - name: Check Minikube nodes
    #   command: kubectl get nodes
    #   register: nodes
    #   until: nodes.rc == 0
    #   retries: 20
    #   delay: 10

    - name: Display nodes
      debug:
        msg: "{{ nodes.stdout_lines }}"

    # ============================================
    # 7. Enable Minikube addons
    # ============================================
    - name: Enable Ingress addon
      command: minikube addons enable ingress
      register: ingress_result
      retries: 3
      delay: 10
      until: ingress_result.rc == 0

    - name: Enable MetalLB addon
      command: minikube addons enable metallb
      register: metallb_result
      retries: 3
      delay: 10
      until: metallb_result.rc == 0

    # ============================================
    # 8. Get server IP
    # ============================================
    - name: Get server IP
      shell: hostname -I | awk '{print $1}'
      register: server_ip
      changed_when: false

    - name: Display server IP
      debug:
        msg: "Server IP: {{ server_ip.stdout }}"

    # ============================================
    # 9. Build Docker images
    # ============================================
    - name: Build API Docker image
      shell: |
        cd /home/wissal/Notes-app/app/api
        docker build -t notes-api:1.0 .
      args:
        chdir: /home/wissal/Notes-app/app/api

    - name: Build Frontend Docker image
      shell: |
        cd /home/wissal/Notes-app/app/frontend
        docker build -t notes-frontend:1.0 .
      args:
        chdir: /home/wissal/Notes-app/app/frontend

    - name: Load images into Minikube
      shell: |
        minikube image load notes-api:1.0
        minikube image load notes-frontend:1.0

    # ============================================
    # 10. Deploy PostgreSQL
    # ============================================
    - name: Create DB Secret
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: db-secret
          type: Opaque
          stringData:
            POSTGRES_USER: notes
            POSTGRES_PASSWORD: notespass
            POSTGRES_DB: notesdb

    - name: Deploy PostgreSQL StatefulSet
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: notes-db
          spec:
            serviceName: notes-db
            replicas: 1
            selector:
              matchLabels:
                app: notes-db
            template:
              metadata:
                labels:
                  app: notes-db
              spec:
                containers:
                - name: postgres
                  image: postgres:15-alpine
                  ports:
                  - containerPort: 5432
                  env:
                  - name: POSTGRES_USER
                    valueFrom:
                      secretKeyRef:
                        name: db-secret
                        key: POSTGRES_USER
                  - name: POSTGRES_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: db-secret
                        key: POSTGRES_PASSWORD
                  - name: POSTGRES_DB
                    valueFrom:
                      secretKeyRef:
                        name: db-secret
                        key: POSTGRES_DB
                  volumeMounts:
                  - name: postgres-storage
                    mountPath: /var/lib/postgresql/data
            volumeClaimTemplates:
            - metadata:
                name: postgres-storage
              spec:
                accessModes: ["ReadWriteOnce"]
                resources:
                  requests:
                    storage: 2Gi

    - name: Deploy PostgreSQL Service
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: notes-db
          spec:
            selector:
              app: notes-db
            ports:
            - port: 5432
              targetPort: 5432

    # ============================================
    # 11. Deploy API & Frontend
    # ============================================
    - name: Deploy API Deployment
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: notes-api
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: notes-api
            template:
              metadata:
                labels:
                  app: notes-api
              spec:
                containers:
                - name: api
                  image: notes-api:1.0
                  imagePullPolicy: Never
                  ports:
                  - containerPort: 5000
                  env:
                  - name: DATABASE_URL
                    value: "postgresql://notes:notespass@notes-db:5432/notesdb"

    - name: Deploy Frontend Deployment
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: notes-frontend
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: notes-frontend
            template:
              metadata:
                labels:
                  app: notes-frontend
              spec:
                containers:
                - name: frontend
                  image: notes-frontend:1.0
                  imagePullPolicy: Never
                  ports:
                  - containerPort: 80

    # ============================================
    # 12. Deploy Services & Ingress
    # ============================================
    - name: Deploy API Service
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: notes-api
          spec:
            selector:
              app: notes-api
            ports:
            - port: 5000
              targetPort: 5000

    - name: Deploy Frontend Service
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: notes-frontend
          spec:
            selector:
              app: notes-frontend
            ports:
            - port: 80
              targetPort: 80

    - name: Deploy Ingress
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: notesapp-ingress
            annotations:
              nginx.ingress.kubernetes.io/rewrite-target: /
          spec:
            rules:
            - host: "notes.{{ server_ip.stdout }}.nip.io"
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: notes-frontend
                      port:
                        number: 80

    # ============================================
    # 13. Wait for pods & display
    # ============================================
    - name: Wait until all pods are ready
      command: kubectl wait --for=condition=ready pod --all -n notesapp --timeout=300s
      retries: 5
      delay: 30
      register: pods_ready
      until: pods_ready.rc == 0

    - name: Show pods
      command: kubectl get pods -n notesapp -o wide
      register: pods
      changed_when: false

    - name: Show services
      command: kubectl get svc -n notesapp
      register: services
      changed_when: false

    - name: Show ingress
      command: kubectl get ingress -n notesapp
      register: ingress
      changed_when: false

    - name: Display summary
      debug:
        msg:
          - "========================================="
          - "‚úÖ D√âPLOIEMENT R√âUSSI !"
          - "========================================="
          - "üì¶ PODS:"
          - "{{ pods.stdout_lines }}"
          - "üîå SERVICES:"
          - "{{ services.stdout_lines }}"
          - "üåê INGRESS:"
          - "{{ ingress.stdout_lines }}"
          - "üåê URL:"
          - "http://notes.{{ server_ip.stdout }}.nip.io"
          - "========================================="
