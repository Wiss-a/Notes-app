---
- name: Deploy NotesApp on Kubernetes
  hosts: servers
  gather_facts: true
  become: true

  tasks:
    # ============================================
    # 1. V√©rifications pr√©liminaires
    # ============================================
    - name: V√©rifier que Docker est d√©marr√©
      service:
        name: docker
        state: started
      ignore_errors: true

    - name: Attendre que Docker soit pr√™t
      wait_for:
        path: /var/run/docker.sock
        timeout: 60

    - name: V√©rifier les outils install√©s
      debug:
        msg: "Tous les outils sont install√©s: Docker, kubectl, Minikube, Terraform"

    # ============================================
    # 2. Nettoyer Minikube existant
    # ============================================
    - name: Arr√™ter Minikube existant
      command: minikube delete
      ignore_errors: true

    # ============================================
    # 3. D√©marrer Minikube avec driver=none
    # ============================================
    - name: D√©marrer Minikube (driver=docker)
      command: minikube start --driver=docker --force
      environment:
        MINIKUBE_HOME: /root
      async: 600
      poll: 0
      register: minikube_start_job

    - name: Attendre le d√©marrage de Minikube
      async_status:
        jid: "{{ minikube_start_job.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 60
      delay: 10

    - name: V√©rifier que Minikube fonctionne
      command: kubectl get nodes
      register: nodes
      until: nodes.rc == 0
      retries: 20
      delay: 10
      changed_when: false

    - name: Afficher les nodes Kubernetes
      debug:
        msg: "{{ nodes.stdout_lines }}"

    # ============================================
    # 4. Configurer les addons
    # ============================================
    - name: Activer addon Ingress
      command: minikube addons enable ingress
      register: ingress_result
      retries: 3
      delay: 10
      until: ingress_result.rc == 0

    - name: Activer addon MetalLB
      command: minikube addons enable metallb
      register: metallb_result
      retries: 3
      delay: 10
      until: metallb_result.rc == 0

    # ============================================
    # 5. Obtenir l'IP
    # ============================================
    - name: Obtenir l'IP du serveur
      shell: hostname -I | awk '{print $1}'
      register: server_ip
      changed_when: false

    - name: Afficher l'IP
      debug:
        msg: "IP du serveur: {{ server_ip.stdout }}"

    # ============================================
    # 6. Cr√©er le namespace
    # ============================================
    - name: Cr√©er namespace notesapp
      command: kubectl create namespace notesapp
      register: ns_result
      failed_when: 
        - ns_result.rc != 0
        - '"already exists" not in ns_result.stderr'

   # ============================================
    # 7. Build des images Docker
    # ============================================
    - name: V√©rifier si l'image API existe
      shell: docker images notes-api:1.0 -q
      register: api_image_check
      changed_when: false

    - name: Build image API
      shell: |
        cd /opt/notesapp/app/api
        docker build -t notes-api:1.0 .
      when: api_image_check.stdout == ""
      register: api_build

    - name: V√©rifier si l'image Frontend existe
      shell: docker images notes-frontend:1.0 -q
      register: frontend_image_check
      changed_when: false

    - name: Build image Frontend
      shell: |
        cd /opt/notesapp/app/frontend
        docker build -t notes-frontend:1.0 .
      when: frontend_image_check.stdout == ""
      register: frontend_build

    - name: Charger les images dans Minikube
      shell: |
        minikube image load notes-api:1.0
        minikube image load notes-frontend:1.0
      register: image_load
      changed_when: true

    - name: Afficher r√©sultat des builds
      debug:
        msg:
          - "Images Docker cr√©√©es et charg√©es dans Minikube"
          - "API: notes-api:1.0"
          - "Frontend: notes-frontend:1.0"
    # ============================================
    # 8. D√©ployer la base de donn√©es
    # ============================================
    - name: D√©ployer PostgreSQL avec Secret
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: db-secret
          type: Opaque
          stringData:
            POSTGRES_USER: notes
            POSTGRES_PASSWORD: notespass
            POSTGRES_DB: notesdb

    - name: D√©ployer PostgreSQL StatefulSet
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: notes-db
          spec:
            serviceName: notes-db
            replicas: 1
            selector:
              matchLabels:
                app: notes-db
            template:
              metadata:
                labels:
                  app: notes-db
              spec:
                containers:
                - name: postgres
                  image: postgres:15-alpine
                  ports:
                  - containerPort: 5432
                  env:
                  - name: POSTGRES_USER
                    valueFrom:
                      secretKeyRef:
                        name: db-secret
                        key: POSTGRES_USER
                  - name: POSTGRES_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: db-secret
                        key: POSTGRES_PASSWORD
                  - name: POSTGRES_DB
                    valueFrom:
                      secretKeyRef:
                        name: db-secret
                        key: POSTGRES_DB
                  volumeMounts:
                  - name: postgres-storage
                    mountPath: /var/lib/postgresql/data
            volumeClaimTemplates:
            - metadata:
                name: postgres-storage
              spec:
                accessModes: ["ReadWriteOnce"]
                resources:
                  requests:
                    storage: 2Gi

    - name: D√©ployer PostgreSQL Service
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: notes-db
          spec:
            selector:
              app: notes-db
            ports:
            - port: 5432
              targetPort: 5432

    # ============================================
    # 9. D√©ployer l'API
    # ============================================
    - name: D√©ployer API Deployment
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: notes-api
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: notes-api
            template:
              metadata:
                labels:
                  app: notes-api
              spec:
                containers:
                - name: api
                  image: notes-api:1.0
                  imagePullPolicy: Never
                  ports:
                  - containerPort: 5000
                  env:
                  - name: DATABASE_URL
                    value: "postgresql://notes:notespass@notes-db:5432/notesdb"

    - name: D√©ployer API Service
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: notes-api
          spec:
            selector:
              app: notes-api
            ports:
            - port: 5000
              targetPort: 5000

    # ============================================
    # 10. D√©ployer le Frontend
    # ============================================
    - name: D√©ployer Frontend Deployment
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: notes-frontend
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: notes-frontend
            template:
              metadata:
                labels:
                  app: notes-frontend
              spec:
                containers:
                - name: frontend
                  image: notes-frontend:1.0
                  imagePullPolicy: Never
                  ports:
                  - containerPort: 80

    - name: D√©ployer Frontend Service
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: notes-frontend
          spec:
            selector:
              app: notes-frontend
            ports:
            - port: 80
              targetPort: 80

    # ============================================
    # 11. D√©ployer l'Ingress
    # ============================================
    - name: D√©ployer Ingress
      k8s:
        state: present
        namespace: notesapp
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: notesapp-ingress
            annotations:
              nginx.ingress.kubernetes.io/rewrite-target: /
          spec:
            rules:
            - host: "notes.{{ server_ip.stdout }}.nip.io"
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: notes-frontend
                      port:
                        number: 80

    # ============================================
    # 12. Attendre que tout soit pr√™t
    # ============================================
    - name: Attendre que tous les pods soient pr√™ts
      command: kubectl wait --for=condition=ready pod --all -n notesapp --timeout=300s
      register: pods_ready
      retries: 5
      delay: 30
      until: pods_ready.rc == 0

    # ============================================
    # 13. Afficher les r√©sultats
    # ============================================
    - name: Obtenir tous les pods
      command: kubectl get pods -n notesapp -o wide
      register: pods
      changed_when: false

    - name: Obtenir tous les services
      command: kubectl get svc -n notesapp
      register: services
      changed_when: false

    - name: Obtenir l'Ingress
      command: kubectl get ingress -n notesapp
      register: ingress
      changed_when: false

    - name: Afficher le r√©sum√© du d√©ploiement
      debug:
        msg:
          - "========================================="
          - "‚úÖ D√âPLOIEMENT R√âUSSI !"
          - "========================================="
          - ""
          - "üì¶ PODS:"
          - "{{ pods.stdout_lines }}"
          - ""
          - "üîå SERVICES:"
          - "{{ services.stdout_lines }}"
          - ""
          - "üåê INGRESS:"
          - "{{ ingress.stdout_lines }}"
          - ""
          - "========================================="
          - "üåê URL d'acc√®s:"
          - "http://notes.{{ server_ip.stdout }}.nip.io"
          - "========================================="