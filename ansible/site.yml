---
- name: Deploy NotesApp on Kubernetes
  hosts: servers
  gather_facts: true
  become: true

  tasks:
    # ============================================
    # 1-6. Installation des outils (comme avant)
    # ============================================
    - name: V√©rifier que Docker est d√©marr√©
      service:
        name: docker
        state: started
      ignore_errors: true

    # ... (toutes les √©tapes d'installation)

    - name: D√©marrer Minikube
      command: minikube start --driver=docker --force
      environment:
        MINIKUBE_HOME: /root
      async: 600
      poll: 0
      register: minikube_start_job

    - name: Attendre le d√©marrage de Minikube
      async_status:
        jid: "{{ minikube_start_job.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 60
      delay: 10

    - name: Activer addon Ingress
      command: minikube addons enable ingress
      register: ingress_result
      retries: 3
      delay: 10
      until: ingress_result.rc == 0

    - name: Activer addon MetalLB
      command: minikube addons enable metallb
      register: metallb_result
      retries: 3
      delay: 10
      until: metallb_result.rc == 0

    - name: Obtenir l'IP du serveur
      shell: hostname -I | awk '{print $1}'
      register: server_ip
      changed_when: false

    # ============================================
    # 7. BUILD DES IMAGES DOCKER
    # ============================================
    - name: Build image API
      shell: |
        cd /opt/notesapp/app/api
        docker build -t notes-api:1.0 .
      register: api_build
      changed_when: "'Successfully built' in api_build.stdout"

    - name: Build image Frontend
      shell: |
        cd /opt/notesapp/app/frontend
        docker build -t notes-frontend:1.0 .
      register: frontend_build
      changed_when: "'Successfully built' in frontend_build.stdout"

    - name: Charger les images dans Minikube
      shell: |
        minikube image load notes-api:1.0
        minikube image load notes-frontend:1.0
      register: image_load

    - name: Afficher r√©sultat des builds
      debug:
        msg:
          - "‚úÖ Images Docker construites et charg√©es dans Minikube"

    # ============================================
    # 8. DEPLOIEMENT AVEC TERRAFORM
    # ============================================
    - name: Cr√©er le fichier terraform.tfvars
      copy:
        content: |
          vm_ip = "{{ server_ip.stdout }}"
          namespace = "notesapp"
        dest: /opt/notesapp/terraform/terraform.tfvars
        mode: '0644'

    - name: Initialiser Terraform
      shell: terraform init
      args:
        chdir: /opt/notesapp/terraform
      register: tf_init

    - name: Afficher r√©sultat init Terraform
      debug:
        msg: "{{ tf_init.stdout_lines }}"

    - name: Planifier le d√©ploiement Terraform
      shell: terraform plan -out=tfplan
      args:
        chdir: /opt/notesapp/terraform
      register: tf_plan
      environment:
        KUBE_CONFIG_PATH: /root/.kube/config

    - name: Afficher le plan Terraform
      debug:
        msg: "{{ tf_plan.stdout_lines }}"

    - name: Appliquer le d√©ploiement Terraform
      shell: terraform apply -auto-approve tfplan
      args:
        chdir: /opt/notesapp/terraform
      register: tf_apply
      environment:
        KUBE_CONFIG_PATH: /root/.kube/config

    - name: Afficher r√©sultat Terraform
      debug:
        msg: "{{ tf_apply.stdout_lines }}"

    - name: R√©cup√©rer les outputs Terraform
      shell: terraform output -json
      args:
        chdir: /opt/notesapp/terraform
      register: tf_outputs
      changed_when: false

    - name: Afficher les outputs Terraform
      debug:
        msg: "{{ tf_outputs.stdout }}"

    # ============================================
    # 9. VERIFICATIONS FINALES
    # ============================================
    - name: Attendre que tous les pods soient pr√™ts
      command: kubectl wait --for=condition=ready pod --all -n notesapp --timeout=300s
      register: pods_ready
      retries: 5
      delay: 30
      until: pods_ready.rc == 0

    - name: Obtenir tous les pods
      command: kubectl get pods -n notesapp -o wide
      register: pods
      changed_when: false

    - name: Obtenir tous les services
      command: kubectl get svc -n notesapp
      register: services
      changed_when: false

    - name: Obtenir l'Ingress
      command: kubectl get ingress -n notesapp
      register: ingress
      changed_when: false

    - name: Afficher le r√©sum√© du d√©ploiement
      debug:
        msg:
          - "========================================="
          - "‚úÖ D√âPLOIEMENT R√âUSSI !"
          - "========================================="
          - ""
          - "üì¶ PODS:"
          - "{{ pods.stdout_lines }}"
          - ""
          - "üîå SERVICES:"
          - "{{ services.stdout_lines }}"
          - ""
          - "üåê INGRESS:"
          - "{{ ingress.stdout_lines }}"
          - ""
          - "========================================="
          - "üåê URL d'acc√®s:"
          - "http://notes.{{ server_ip.stdout }}.nip.io"
          - "========================================="